<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kingdom Rescue – Foster Portal</title>
  <style>
    /* —— Theme —— */
    :root{
      --bg:#0a0a0b;
      --panel:#111214cc;
      --border:#ffffff1a;
      --text:#f4f4f5;
      --muted:#a1a1aa;
      --accent:#10b981;
      --accent-2:#14b8a6;
      --shadow:0 10px 30px rgba(0,0,0,.45);
      --railH:72px;           /* mobile bottom rail height */
      --navH:64px;            /* height of the below-image nav strip with arrows */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font:14px/1.4 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      -webkit-font-smoothing:antialiased
    }
    a{color:inherit;text-decoration:none}
    .hidden{display:none}
    .no-scrollbar{scrollbar-width:none}
    .no-scrollbar::-webkit-scrollbar{display:none}

    /* —— App Layout —— */
    .app{height:100dvh;width:100vw;display:flex;flex-direction:column;overflow:hidden}
    @media(min-width:768px){.app{flex-direction:row}}

    /* Sidebar (desktop) */
    .sidebar{
      display:none;width:288px;flex:0 0 288px;
      border-right:1px solid var(--border);
      background:#0b0c0dcc;backdrop-filter:saturate(120%) blur(8px)
    }
    @media(min-width:768px){.sidebar{display:flex;flex-direction:column}}

    /* Header */
    .header{
      padding:16px 16px 8px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(180deg,rgba(255,255,255,.02),transparent)
    }
    .brand{display:flex;align-items:center;gap:12px}

    /* logo is an <img> */
    .logo{
      width:40px;height:40px;border-radius:10px;
      object-fit:contain; object-position:center;
      display:block; background:#0c0c0d;
      padding:2px;
    }

    .title{font-weight:700;letter-spacing:-.01em}
    .subtitle{color:var(--muted);font-size:12px;margin-top:2px}

    /* Search */
    .search{position:relative;padding:12px 16px}
    .search input{
      width:100%;padding:10px 12px;border-radius:12px;
      border:1px solid var(--border);background:#121316c0;color:var(--text);outline:none
    }
    .search input:focus{box-shadow:0 0 0 3px color-mix(in oklab,var(--accent) 35%, transparent)}
    .search-list{
      position:absolute;left:16px;right:16px;top:56px;
      background:#0f1014f2;border:1px solid var(--border);border-radius:12px;
      box-shadow:var(--shadow);max-height:280px;overflow:auto;z-index:50
    }
    .search-item{
      display:block;width:100%;text-align:left;padding:10px 12px;border-radius:10px;
      background:transparent;border:0;color:var(--text)
    }
    .search-item:hover{background:rgba(255,255,255,.05)}
    .search-item small{display:block;color:var(--muted)}

    /* Thumbnails */
    .thumbs-vertical{flex:1;overflow:auto;padding:0 12px 12px}
    .thumbs-horizontal{display:flex;gap:8px;overflow:auto;padding:8px 8px}
    .thumb{
      display:flex;align-items:center;gap:10px;
      border:1px solid var(--border);background:#0f1012b3;border-radius:16px;
      padding:8px;transition:.18s ease;position:relative;
      -webkit-appearance:none;appearance:none;margin:0;width:100%;height:80px;overflow:hidden;
      color:var(--text);
    }
    .thumb:hover{background:#0f1012cc}
    .thumb.active{outline:3px solid color-mix(in oklab,var(--accent) 55%, transparent)}
    .thumb img{
      width:64px;height:64px;object-fit:cover;border-radius:12px;flex:0 0 64px;background:#111
    }
    .thumb > div{display:flex;flex-direction:column;justify-content:center;min-width:0}
    .thumb .name{font-weight:600;font-size:14px;color:var(--text)}
    .thumb .meta{color:var(--muted);font-size:12px}
    .badge{font-size:10px;color:#7bfcc7}
    .thumb .name,.thumb .meta,.thumb .badge{
      line-height:1.15;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:160px
    }

    /* Main */
    .main{position:relative;flex:1;display:flex;flex-direction:column}
    .topbar{display:block;border-bottom:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,.02),transparent)}
    @media(min-width:768px){.topbar.mobile{display:none}}

    .profilebar{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 16px;border-bottom:1px solid var(--border);
      background:#0f1012a0;backdrop-filter:blur(8px)
    }
    .label{color:var(--muted);text-transform:uppercase;font-size:12px}
    .openbtn{border:1px solid var(--border);padding:8px 10px;border-radius:12px;background:transparent;color:var(--text)}
    .openbtn:hover{background:rgba(255,255,255,.06)}
    .profile-actions{display:flex;align-items:center;gap:8px}
    .profile-btn{
      width:36px;height:36px;display:inline-flex;align-items:center;justify-content:center;
      border:1px solid var(--border);border-radius:10px;background:#0f1012b3;color:var(--text);cursor:pointer;outline:none;
      transition:background .15s ease, transform .08s ease;
      touch-action:manipulation;
    }
    .profile-btn:hover{background:#0f1012cc}
    .profile-btn:active{transform:scale(.97)}
    .profile-btn svg{width:22px;height:22px}
    .fee{
      margin-left:8px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;
      background:#0b0c0fcc;color:#e5e7eb;font-weight:700;letter-spacing:.2px
    }
    /* Fit toggle (mobile only) */
    .fitbtn{border:1px solid var(--border);padding:8px 10px;border-radius:12px;background:transparent;color:var(--text)}
    .fitbtn:hover{background:rgba(255,255,255,.06)}
    @media(min-width:768px){ .fitbtn{display:none} }

    @media (max-width: 359px){
      .profile-btn{width:32px;height:32px}
      .profile-btn svg{width:18px;height:18px}
      .fee{padding:5px 8px;font-size:12px}
    }

    /* Viewport now leaves space for the arrow strip below */
    .viewport{position:absolute;left:0;right:0;top:64px;bottom:var(--navH)}
    @media(min-width:768px){.viewport{top:68px;bottom:var(--navH)}}
    @media(max-width:767px){.viewport{bottom:calc(var(--railH) + var(--navH) + env(safe-area-inset-bottom,0px))}}
    .viewport iframe,.viewport img{width:100%;height:100%;display:block;position:relative;z-index:10}
    .viewport img{object-fit:contain;background:black}

    /* Fit Width mode */
    .fit-width .viewport{overflow:auto}
    .fit-width .viewport img{height:auto;width:100%;object-fit:unset}

    /* ===== Below-image arrow strip (doesn't cover the image) ===== */
    .view-actions{
      position:absolute;left:0;right:0;height:var(--navH);
      bottom:var(--navH); /* default; immediately overridden by media rules below */
      display:flex;align-items:center;justify-content:space-between;
      padding:0 10px;gap:10px;z-index:25;pointer-events:none;
    }
    @media(min-width:768px){
      .view-actions{bottom:0} /* desktop: sits at bottom of main; viewport already reserved space */
    }
    @media(max-width:767px){
      .view-actions{bottom:calc(var(--railH) + env(safe-area-inset-bottom,0px))}
    }
    .view-actions .profile-btn{
      pointer-events:auto;
      width:64px;height:64px;border-radius:999px;
      background:#0f1012e6;border:1px solid var(--border);
      box-shadow:var(--shadow);
    }
    .view-actions .profile-btn svg{width:34px;height:34px}
    @media(max-width:480px){
      .view-actions .profile-btn{width:56px;height:56px}
      .view-actions .profile-btn svg{width:28px;height:28px}
    }

    /* Note */
    .note{
      position:absolute;left:0;right:0;bottom:calc(var(--railH) + var(--navH) + 8px);
      text-align:center;color:var(--muted);font-size:12px
    }
    @media(min-width:768px){.note{bottom:calc(var(--navH) + 8px)}}

    /* Bottom rail (mobile) */
    .bottomrail{
      border-top:1px solid var(--border);background:#0f1012a6;backdrop-filter:blur(8px);
      position:absolute;left:0;right:0;bottom:0;height:var(--railH);z-index:60
    }
    @media(min-width:768px){.bottomrail{display:none}}

    /* Welcome fallback */
    .welcome{position:absolute;inset:0;display:grid;place-items:center;padding:24px}
    .wel-card{
      max-width:900px;width:min(100%,900px);
      border:1px solid var(--border);border-radius:24px;
      background:linear-gradient(135deg,rgba(16,185,129,.18),rgba(20,184,166,.08));
      padding:28px;box-shadow:var(--shadow)
    }
    .wel-card h2{margin:0 0 8px;font-size:22px}
    .wel-card p{margin:0 0 14px;color:#e5e7eb}
    .wel-grid{display:grid;grid-template-columns:1fr;gap:10px}
    .wel-item{padding:10px 12px;border-radius:14px;background:#0b0c0f80;border:1px solid var(--border)}
    @media(min-width:640px){.wel-grid{grid-template-columns:repeat(3,1fr)}}

    /* --- Mobile layout tweaks --- */
    @media (max-width: 767px){
      :root{ --railH:112px; } /* taller rail so 80px thumbs fit */

      .bottomrail{ height: var(--railH); }
      .thumbs-horizontal .thumb{ width:auto; min-width:240px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar (desktop) -->
    <aside class="sidebar" id="sidebar">
      <div class="header">
        <div class="brand">
          <img src="assets/krlogo.jpeg" alt="Kingdom Rescue logo" class="logo" />
          <div>
            <div class="title">Kingdom Rescue</div>
            <div class="subtitle">Scan → Browse → Tap profile</div>
          </div>
        </div>
      </div>
      <div class="search">
        <input id="search" placeholder="Search name, sex, age…" />
        <div id="searchList" class="search-list hidden"></div>
      </div>
      <div id="thumbsVertical" class="thumbs-vertical no-scrollbar"></div>
    </aside>

    <!-- Main -->
    <main class="main">
      <!-- Top (mobile) header + search -->
      <div class="topbar mobile">
        <div class="header">
          <div class="brand">
            <img src="assets/krlogo.jpeg" alt="Kingdom Rescue logo" class="logo" />
            <div>
              <div class="title">Kingdom Rescue</div>
              <div class="subtitle">Scan → Browse → Tap profile</div>
            </div>
          </div>
        </div>
        <div class="search">
          <input id="searchM" placeholder="Search name, sex, age…" />
          <div id="searchListM" class="search-list hidden"></div>
        </div>
      </div>

      <!-- Profile title bar -->
      <div class="profilebar">
        <div>
          <div class="label">Profile</div>
          <div id="profileTitle" style="font-weight:700"></div>
          <div id="profileMeta" class="subtitle" style="margin-top:2px"></div>
        </div>
        <div class="profile-actions">
          <span class="fee">Adoption fee: $125</span>
          <button id="btnPrev" class="profile-btn" aria-label="Previous profile" title="Previous (←)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
          </button>
          <button id="btnNext" class="profile-btn" aria-label="Next profile" title="Next (→)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
          </button>
          <a id="openExternal" class="openbtn" target="_blank" rel="noreferrer">Open in new tab</a>
          <!-- Fit toggle (mobile only) -->
          <button id="fitToggle" class="fitbtn" aria-pressed="false" title="Toggle between Fit width and Fit screen">Fit width</button>
        </div>
      </div>

      <!-- Viewport -->
      <div class="viewport" id="viewport"></div>

      <!-- Below-image arrow strip -->
      <div class="view-actions" aria-hidden="false">
        <button id="viewPrev" class="profile-btn" aria-label="Previous profile" title="Previous (←)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
        </button>
        <button id="viewNext" class="profile-btn" aria-label="Next profile" title="Next (→)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
        </button>
      </div>

      <div class="note">Adoption fee for all cats is <strong>$125</strong>.</div>

      <!-- Bottom thumbnails (mobile) -->
      <div class="bottomrail">
        <div id="thumbsHorizontal" class="thumbs-horizontal no-scrollbar"></div>
      </div>
    </main>
  </div>

  <!-- Firebase SDKs -->
  <script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    function startApp(){  /* ===== EVERYTHING inside this function ===== */

    /* ======================
       1) DATA
       ====================== */
    const ANIMALS = [
      { id:'welcome',        name:'Welcome',       species:'',                  thumb:'thumbs/welcome_thumb.png',       profileUrl:'profiles/welcome_full.png' },
      { id:'adoption_info',  name:'Adoption Info', species:'Rescue details',    thumb:'thumbs/adoption_info_thumb.jpg', profileUrl:'profiles/adoption_info.png' },

      { id:'aj',        name:'A.J.',          species:'Male • 4 months',   thumb:'thumbs/aj_thumb.jpg',        profileUrl:'profiles/aj.png' },
      { id:'alfalfa',   name:'Alfalfa',       species:'Male • 4 months',   thumb:'thumbs/alfalfa_thumb.jpg',   profileUrl:'profiles/alfalfa.png' },
      { id:'april',     name:"April O'Neil",  species:'Female • 1 year',   thumb:'profiles/april.png',     profileUrl:'profiles/april.png' },
      { id:'buckwheat', name:'Buckwheat',     species:'Male • 4 months',   thumb:'thumbs/buckwheat_thumb.jpg', profileUrl:'profiles/buckwheat.png' },
      { id:'dolly',     name:'Dolly',         species:'Female • 3 months', thumb:'thumbs/dolly_thumb.jpg',     profileUrl:'profiles/dolly.png' },
      { id:'donovan',   name:'Donovan',       species:'Male • 2 years',    thumb:'thumbs/donovan_thumb.jpg',   profileUrl:'profiles/donovan.png' },
      { id:'jean',      name:'Jean Darling',  species:'Female • 4 months', thumb:'thumbs/jean_thumb.jpg',      profileUrl:'profiles/jean.png' },
      { id:'joey',      name:'Joey',          species:'Male • 6 months',   thumb:'thumbs/joey_thumb.jpg',      profileUrl:'profiles/joey.png' },
      { id:'labooboo',  name:'La-Boo-Boo',    species:'Female • 4 months', thumb:'thumbs/labooboo_thumb.jpg',  profileUrl:'profiles/labooboo.png' },
      { id:'porky',     name:'Porky',         species:'Male • 4 months',   thumb:'thumbs/porky_thumb.jpg',     profileUrl:'profiles/porky.png' },

      // NEW CATS (thumbs point to profile images for now)
      { id:'leslie',   name:'Leslie',       species:'Female • 4 months', thumb:'profiles/leslie.png', profileUrl:'profiles/leslie.png' },
      { id:'loretta',  name:'Loretta',      species:'Female • 3 months', thumb:'profiles/loretta.png', profileUrl:'profiles/loretta.png' },
      { id:'sonny',    name:'Sonny',        species:'Female • 4 months', thumb:'profiles/sonny.png',   profileUrl:'profiles/sonny.png' },
      { id:'tammy',    name:'Tammy',        species:'Female • 3 months', thumb:'profiles/tammy.png',   profileUrl:'profiles/tammy.png' },
      { id:'timmy',    name:'Timmy-Kevin',  species:'Male • 4 years',    thumb:'profiles/timmy.png',   profileUrl:'profiles/timmy.png' },
      { id:'waylon',   name:'Waylon',       species:'Male • 3 months',   thumb:'profiles/waylon.png',  profileUrl:'profiles/waylon.png' },
      { id:'willy',    name:'Willy',        species:'Male • 3 months',   thumb:'profiles/willy.png',   profileUrl:'profiles/willy.png' }
    ];

    /* ======================
       2) FIREBASE INIT (paste your config)
       ====================== */
    let fbReady = false, auth = null, db = null;

    try{
      // 🔐 Your Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyDKAfB4KVwMS3aXJxrQgqy6GiX0GalzIlw",
        authDomain: "kingdomrescue-4fa02.firebaseapp.com",
        projectId: "kingdomrescue-4fa02",
        storageBucket: "kingdomrescue-4fa02.firebasestorage.app",
        messagingSenderId: "178736516158",
        appId: "1:178736516158:web:2f42c123f151044edf556f"
      };
      if (Object.keys(firebaseConfig).length){
        firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db   = firebase.firestore();
        fbReady = true;
      }
    }catch(e){
      console.warn('Firebase init failed; running in no-backend mode.', e);
      fbReady = false;
    }

    /* ======================
       3) ADOPTED STATE (Firestore + realtime)
       ====================== */
    let adoptedSet = new Set();
    let unsubStatus = null;

    async function loadAdoptedOnce(){
      adoptedSet = new Set();
      if (!fbReady) return;
      try{
        const snap = await db.collection('adoption_status').get();
        snap.forEach(doc=>{ if (doc.data()?.adopted === true) adoptedSet.add(doc.id); });
      }catch(err){
        console.warn('Adoption status load error:', err);
        adoptedSet = new Set();
      }
    }

    function startRealtime(){
      if (!fbReady) return;
      if (unsubStatus) unsubStatus(); // reset if re-called
      unsubStatus = db.collection('adoption_status').onSnapshot(snap=>{
        const next = new Set();
        snap.forEach(doc=>{ if (doc.data()?.adopted === true) next.add(doc.id); });
        const before = JSON.stringify([...adoptedSet].sort());
        const after  = JSON.stringify([...next].sort());
        adoptedSet = next;
        if (before !== after){
          buildThumbs();
          const ids = order();
          if(!ids.includes(activeId)) activeId = ids[0];
          render();
          window.dispatchEvent(new CustomEvent('adopted-updated'));
        }
      }, err=>{
        console.warn('Realtime listener error:', err);
      });
    }

    // These panels are never hidden even if flagged by mistake
    function isSystem(id){ return id === 'welcome' || id === 'adoption_info'; }

    function visibleAnimals(){
      const list = ANIMALS.filter(a => isSystem(a.id) || !adoptedSet.has(a.id));
      return list.length ? list : ANIMALS.slice();  // hard fallback
    }

    /* ======================
       4) UI HELPERS
       ====================== */
    const qs = new URL(location.href);
    let activeId = qs.searchParams.get('id') || ANIMALS[0].id;

    const order = () => visibleAnimals().map(a=>a.id);
    function goPrev(){ const o=order(); const i=o.indexOf(activeId); setActive(o[(i-1+o.length)%o.length]); }
    function goNext(){ const o=order(); const i=o.indexOf(activeId); setActive(o[(i+1)%o.length]); }

    function setActive(id){
      activeId = id;
      const u = new URL(location.href); u.searchParams.set('id', id); history.replaceState({}, '', u);
      render();
      document.querySelectorAll('.thumb').forEach(el=>el.classList.toggle('active', el.dataset.id===id));
      scrollActiveThumbIntoView();
    }

    const isPdf = url => (url||'').toLowerCase().endsWith('.pdf');

    function render(){
      const list = visibleAnimals();
      const active = list.find(a=>a.id===activeId) || list[0] || ANIMALS[0];

      const title = document.getElementById('profileTitle');
      const meta  = document.getElementById('profileMeta');
      const open  = document.getElementById('openExternal');
      const vp    = document.getElementById('viewport');

      title.textContent = active?.name || 'Profile';
      meta.textContent  = active?.species || '';

      if (active?.profileUrl){ open.href = active.profileUrl; open.style.pointerEvents='auto'; open.style.opacity='1'; }
      else { open.href = '#'; open.style.pointerEvents='none'; open.style.opacity='.6'; }

      if (!active?.profileUrl){
        vp.innerHTML = `
          <div class="welcome">
            <div class="wel-card">
              <h2>Welcome to the Kingdom Rescue Foster Portal</h2>
              <p>Browse the animals below. Tap any profile to view their one-page info sheet. Ask a volunteer if you have questions or want to apply to foster.</p>
              <div class="wel-grid">
                <div class="wel-item">1. Scroll the thumbnail rail and tap a pet.</div>
                <div class="wel-item">2. The profile opens here. Pinch-zoom images or use the <em>Open in new tab</em> button for PDFs.</div>
                <div class="wel-item">3. Use the thumbnails to navigate, or arrow keys on desktop.</div>
              </div>
            </div>
          </div>`;
        return;
      }

      vp.innerHTML = isPdf(active.profileUrl)
        ? `<iframe title="${active.name||'Profile'}" src="${active.profileUrl}" loading="lazy"></iframe>`
        : `<img alt="${active.name||'Profile'}" src="${active.profileUrl}" loading="lazy">`;
    }

    function thumbNode(a){
      const btn = document.createElement('button');
      btn.className = 'thumb'; btn.dataset.id = a.id;
      btn.addEventListener('click',()=>setActive(a.id));
      const thumbSrc = a.thumb || a.profileUrl;

      const showMeta = isSystem(a.id) && a.species;

      btn.innerHTML = `
        <img src="${thumbSrc}" alt="${a.name||'Profile'}" loading="lazy">
        <div>
          <div class="name">${a.name||'Profile'}</div>
          ${showMeta ? `<div class="meta">${a.species}</div>` : ''}
          ${a.id==='welcome'?'<div class="badge">Start here</div>':''}
        </div>`;
      return btn;
    }

    function buildThumbs(){
      const v = document.getElementById('thumbsVertical');
      const h = document.getElementById('thumbsHorizontal');
      if(v) v.innerHTML=''; if(h) h.innerHTML='';
      visibleAnimals().forEach(a=>{
        const V = thumbNode(a), H = thumbNode(a);
        if(a.id===activeId){V.classList.add('active');H.classList.add('active');}
        v && v.appendChild(V); h && h.appendChild(H);
      });
      scrollActiveThumbIntoView();
    }

    /* Auto-scroll the active thumbnail into view (both lists) */
    function scrollActiveThumbIntoView(){
      const id = activeId;
      const v = document.querySelector(`#thumbsVertical .thumb[data-id="${id}"]`);
      const h = document.querySelector(`#thumbsHorizontal .thumb[data-id="${id}"]`);
      if (v){ v.scrollIntoView({behavior:'smooth', block:'nearest', inline:'nearest'}); }
      if (h){ h.scrollIntoView({behavior:'smooth', block:'nearest', inline:'center'}); }
    }

    // Search
    function attachSearch(inputId,listId){
      const input = document.getElementById(inputId);
      const list  = document.getElementById(listId);
      if(!input || !list) return;
      input.addEventListener('input',()=>{
        const s = input.value.trim().toLowerCase();
        if(!s){list.classList.add('hidden'); list.innerHTML=''; return;}
        const res = visibleAnimals()
          .filter(a=>a.id!=='welcome' && a.id!=='adoption_info')
          .filter(a=>((a.name||'').toLowerCase().includes(s) || (a.species||'').toLowerCase().includes(s)))
          .slice(0,8);
        list.innerHTML = res.length
          ? res.map(r=>`<button class="search-item" data-id="${r.id}"><strong>${r.name}</strong><small>${r.species||''}</small></button>`).join('')
          : `<div class="search-item" disabled>No matches.</div>`;
        list.classList.remove('hidden');
      });
      list.addEventListener('click',(e)=>{
        const b = e.target.closest('[data-id]'); if(!b) return;
        setActive(b.dataset.id); list.classList.add('hidden'); input.value='';
      });
      document.addEventListener('click',(e)=>{ if(!list.contains(e.target) && e.target!==input) list.classList.add('hidden'); });
    }

    // Keyboard (incl. Fit toggle on "f")
    function attachKeys(){
      window.addEventListener('keydown',(e)=>{
        if(['ArrowLeft','ArrowUp','a','w'].includes(e.key)) goPrev();
        if(['ArrowRight','ArrowDown','d','s'].includes(e.key)) goNext();
        if(e.key.toLowerCase()==='f'){ toggleFit(); }
      });
    }

    /* ======================
       5) ADMIN PANEL (?admin=1)
       ====================== */
    const isAdminMode = new URL(location.href).searchParams.get('admin') === '1';

    function mountAdminPanel(){
      if (!fbReady) return; // only shown if Firebase is configured
      const wrap = document.createElement('div');
      wrap.innerHTML = `
        <style>
          .admin-panel{
            position:fixed; right:16px; left:16px;
            bottom:calc(var(--railH,72px) + 16px);
            background:#0f1014f0; border:1px solid var(--border); border-radius:16px;
            padding:12px; width:auto; max-width:420px; z-index:2000; box-shadow:var(--shadow);
          }
          .admin-panel h3{margin:0 0 8px;font-size:14px;color:#e5e7eb}
          .admin-row{display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-top:1px solid var(--border)}
          .admin-list{max-height:40vh;overflow:auto}
          .admin-login{display:grid;grid-template-columns:1fr auto;gap:6px;margin:8px 0}
          .admin-login input{min-width:0;width:100%;padding:8px;border-radius:10px;border:1px solid var(--border);background:#121316c0;color:#e5e7eb}
          .admin-btn{border:1px solid var(--border);background:#0f1012b3;color:#e5e7eb;border-radius:10px;padding:8px 10px;cursor:pointer}
          .admin-badge{font-size:11px;padding:2px 6px;border:1px solid var(--border);border-radius:999px;color:#e5e7eb}
          .hidden{display:none}
          @media (max-width:480px){ .admin-login{grid-template-columns:1fr}.admin-btn{width:100%} }
        </style>
        <div class="admin-panel">
          <h3>Admin · Adoption Toggle <span id="adminStatus" class="admin-badge">Signed out</span></h3>
          <div class="admin-login" id="loginBox">
            <input id="adminEmail" type="email" placeholder="Email">
            <input id="adminPass" type="password" placeholder="Password">
            <button class="admin-btn" id="adminSignIn">Sign in</button>
          </div>
          <div class="admin-login hidden" id="logoutBox">
            <small id="whoami"></small>
            <button class="admin-btn" id="adminSignOut">Sign out</button>
          </div>
          <div class="admin-list" id="adminList"></div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="admin-btn" id="refreshAdopted">Refresh</button>
          </div>
        </div>
      `;
      document.body.appendChild(wrap);

      const emailEl = document.getElementById('adminEmail');
      const passEl  = document.getElementById('adminPass');
      if (emailEl){ emailEl.setAttribute('inputmode','email'); emailEl.style.textOverflow='ellipsis'; }
      if (passEl){ passEl.addEventListener('keydown', e => { if(e.key==='Enter') document.getElementById('adminSignIn')?.click(); }); }

      const adminStatus = document.getElementById('adminStatus');
      const loginBox = document.getElementById('loginBox');
      const logoutBox = document.getElementById('logoutBox');
      const whoami = document.getElementById('whoami');
      const adminList = document.getElementById('adminList');

      function renderAdminList(){
        const rows = ANIMALS
          .filter(a => !isSystem(a.id))
          .map(a=>{
            const checked = adoptedSet.has(a.id) ? 'checked' : '';
            return `<div class="admin-row">
              <div style="display:flex;align-items:center;gap:8px">
                <img src="${a.thumb || a.profileUrl}" alt="" style="width:36px;height:36px;object-fit:cover;border-radius:8px;border:1px solid var(--border)">
                <div><div style="font-weight:600">${a.name}</div><small>${a.species||''}</small></div>
              </div>
              <label style="display:flex;align-items:center;gap:6px">
                <small>Adopted</small>
                <input type="checkbox" data-id="${a.id}" ${checked}/>
              </label>
            </div>`;
          }).join('');
        adminList.innerHTML = rows || '<small>No cats.</small>';

        adminList.querySelectorAll('input[type=checkbox]').forEach(cb=>{
          cb.addEventListener('change', async (e)=>{
            const id = e.target.dataset.id;
            const adopted = e.target.checked;
            try{
              await db.collection('adoption_status').doc(id).set({ adopted }, { merge:true });
              if (adopted) adoptedSet.add(id); else adoptedSet.delete(id);
              buildThumbs(); const ids = order(); if(!ids.includes(activeId)) activeId = ids[0]; render();
            }catch(err){
              alert('Update failed. Are you signed in and listed as admin?');
              e.target.checked = !adopted;
            }
          });
        });
      }

      document.getElementById('refreshAdopted').addEventListener('click', async ()=>{
        await loadAdoptedOnce(); renderAdminList(); buildThumbs(); render();
      });
      document.getElementById('adminSignIn').addEventListener('click', async ()=>{
        const email = (document.getElementById('adminEmail').value||'').trim();
        const password = document.getElementById('adminPass').value||'';
        try{ await auth.signInWithEmailAndPassword(email, password); }catch(err){ alert('Sign-in failed'); }
      });
      document.getElementById('adminSignOut').addEventListener('click', async ()=>{ await auth.signOut(); });

      auth.onAuthStateChanged(user=>{
        const authed = !!user;
        adminStatus.textContent = authed ? 'Signed in' : 'Signed out';
        loginBox.classList.toggle('hidden', authed);
        logoutBox.classList.toggle('hidden', !authed);
        whoami.textContent = authed ? (user.email||'') : '';
        renderAdminList();
      });

      window.addEventListener('adopted-updated', renderAdminList);
      renderAdminList();
    }

    /* ======================
       6) BOOT
       ====================== */
    let fitWidth = false;
    function applyFit(){
      document.body.classList.toggle('fit-width', fitWidth);
      const btn = document.getElementById('fitToggle');
      if(btn){
        btn.textContent = fitWidth ? 'Fit screen' : 'Fit width';
        btn.setAttribute('aria-pressed', String(fitWidth));
      }
    }
    function toggleFit(){ fitWidth = !fitWidth; applyFit(); }

    async function boot(){
      await loadAdoptedOnce();
      buildThumbs();
      attachSearch('search','searchList');
      attachSearch('searchM','searchListM');
      attachKeys();

      // Wire arrows
      const btnPrev = document.getElementById('btnPrev');
      const btnNext = document.getElementById('btnNext');
      const viewPrev = document.getElementById('viewPrev');
      const viewNext = document.getElementById('viewNext');
      [btnPrev,viewPrev].forEach(b=>b && b.addEventListener('click',goPrev));
      [btnNext,viewNext].forEach(b=>b && b.addEventListener('click',goNext));
      [btnPrev,btnNext,viewPrev,viewNext].forEach(btn=>{
        if(!btn) return;
        btn.addEventListener('keydown',(e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); (btn===btnPrev||btn===viewPrev)?goPrev():goNext(); }});
      });

      // Fit toggle
      const fitBtn = document.getElementById('fitToggle');
      if(fitBtn){ fitBtn.addEventListener('click', toggleFit); }
      applyFit(); // initialize

      const ids = order();
      if(!ids.includes(activeId)) activeId = ids[0];
      render();

      // Admin panel & realtime
      if (new URL(location.href).searchParams.get('admin') === '1') mountAdminPanel();
      startRealtime();
    }
    boot();

    } /* ===== end startApp ===== */

    // Ensure Firebase SDKs (deferred) are loaded before running app code
    if (window.firebase) startApp();
    else window.addEventListener('load', startApp);
  </script>
</body>
</html>
